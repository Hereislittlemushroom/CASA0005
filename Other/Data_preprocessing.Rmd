---
title: "Reproducible Analysis"
author: "Franklin"
date: "1/5/2021"
output: pdf_document
---

## Read data into R

- The NCR is a database of publicly-available chargepoints for electric vehicles in the UK established in 2011(,2021).

  you can access data in this [link](https://www.gov.uk/guidance/find-and-use-data-on-public-electric-vehicle-chargepoints#accessing-data-on-ncv)

  read full data in R (first we utilise Excel to filter by "Great London")
```{r}
library(tidyverse)
# London_NCR = read_csv("Dataset/national-charge-point-registry.csv")
UK_NCR= read.csv("http://chargepoints.dft.gov.uk/api/retrieve/registry/format/csv")
summary(UK_NCR)

nrow(UK_NCR)
ncol(UK_NCR)

```

## Data selection

select the london area in this UK csv file
```{r}
library(dplyr)

# overview of all different elements of county via unique()
overview_county_temp = London_NCR %>%
  dplyr::arrange(county)
overview_county = overview_county_temp$county %>%
  unique()

# London Borough of Camden
# London Borough of Ealing 
# London Borough of Greenwich 
# London Borough of Hackney                
# London Borough of Hammersmith and Fulham 
# London Borough of Hounslow              
# London Borough of Islington              
# London Borough of Lambeth                
# London Borough of Richmond upon Thames   
# London Borough of Southwark             
# London Borough Of Southwark             
# London Borough of Waltham Forest        
# London Borough of Wandsworth

London_NCR = UK_NCR %>%
  dplyr::filter(  !is.na(county),
                  county == "London" | 
                  county == "Greater London " | 
                  county == "London Borough of Camden" |
                  county == "London Borough of Ealing" | 
                  county == "London Borough of Greenwich" | 
                  county == "London Borough of Hackney" | 
                  county == "London Borough of Hammersmith and Fulham" | 
                  county == "London Borough of Hounslow" | 
                  county == "London Borough of Islington" | 
                  county == "London Borough of Lambeth" | 
                  county == "London Borough of Richmond upon Thames" | 
                  county == "London Borough of Southwark" |
                  county == "London Borough Of Southwark" |
                  county == "London Borough of Waltham Forest" | 
                  county == "London Borough of Wandsworth")
```

Check if county in London_NCR is London
```{r}
temp = London_NCR$county %>%
  unique()
temp
```

In the next step, we can select the valuable attributes e.g. latitude,longitude!
```{r}
# R language start from 1
London_NCR = London_NCR %>%
  select(1,4,5,13,14,15,32,35,36,38,54)

# check the cols' names
London_NCR %>%
  names()

London_NCR %>%
  nrow()
London_NCR %>%
  ncol()
```


## Data Cleaning

- 思考：如果可以把NCR里的数据对应到GSS_CODE，按照assignment/geographic information/里的步骤join data就可以得到地理热点图！

首先找到GSS_Code与Postcode对应表，通过google找到PostcodesioR包，安装并运行PostcodesioR
```{r}
install.packages("PostcodesioR")
library(PostcodesioR)
```

### 方法一: 试图取巧(没有成功)
为了将London-NCR的postcode和伦敦GSS_Code对应起来，以此来实现后期画地理热点图的需要，根据PostcodesioR的文档指南如下操作
```{r}
# case1
library(PostcodesioR)
pc_list <- list(postcodes = c("PR3 0SG", "M45 6GN", "EX165BL"))
bulk_lookup_result <- bulk_postcode_lookup(pc_list)

#overview
str(bulk_lookup_result[1])

library(purrr)

bulk_list <- lapply(bulk_lookup_result, "[[", 2)

# 写一个函数来提取list中的list
subdate<- function(x){
x$`admin_district`
}
subdate(bulk_list$codes)

bulk_df <-
  map_dfr(bulk_list,
          `[`,
          c("postcode", "longitude", "latitude", subdate("codes")))

```
事实证明上述方法包含list中嵌套list,于是来尝试mutata_each，对每一行进行函数操作!

### 方法二: 使用apply进行批量操作
```{r}
London_NCR_GSS_Added = London_NCR %>%
  rowwise() %>%
  mutate(GSS_CODE = postcode) %>%
  mutate(GSS_CODE = as.character(GSS_CODE))
# 注意转化成字符型方便后面loop直接赋值！

London_NCR_temp1 = head(London_NCR_GSS_Added)

library(PostcodesioR)

postcode2gsscode = function(x){
  
}

apply(London_NCR_temp1, MARGIN, postcode2gsscode, ...)
```

### 方法三: 笨笨方法循环(成功了！)

先使用dplyr中的rowwise方法，写个循环来加上GSS_CODE
```{r}

London_NCR_GSS_Added = London_NCR %>%
  rowwise() %>%
  mutate(GSS_CODE = postcode) %>%
  mutate(GSS_CODE = as.character(GSS_CODE))
# 注意转化成字符型方便后面loop直接赋值！

London_NCR_temp = London_NCR_GSS_Added

library(PostcodesioR)
i = 1
for (val in London_NCR_temp$postcode) {
  try({ temp = PostcodesioR::postcode_lookup(val)
        if(!is.null(temp)){
          temp1 = temp$admin_district_code[1]
          London_NCR_temp$GSS_CODE[i] = temp1
          # print(i)
        }else{
          London_NCR_temp$GSS_CODE[i] = ""
          # print("cannot find ")
          # print(val)
          # print(i)
        }
        i = i+1 }
      ,silent = TRUE)
}
# pay attention to the for loop in dataframe, it start from 1 !!!!

London_NCR_GSS_Added = London_NCR_temp

# remove the value which is empty in GSS_CODE
London_NCR_GSS_Added$GSS_CODE[London_NCR_GSS_Added$GSS_CODE==""] = NA
London_NCR_GSS_Added = London_NCR_GSS_Added %>%
  filter(!is.na(GSS_CODE))
```
事实证明可以运行！可以看到在London_NCR_GSS_Added中多了新的一列GSS_CODE新变量，可以用来做csv的表合并！

- Finally, it is of importance to export our prepossessed data into csv file! Now we get the London_NCR_GSS_Added.csv in our "/Dataset" path
```{r}
# 把我们珍贵的带有GSS_CODE数据提取到/Dataset文件里
library(here)
# write_csv(London_NCR_GSS_Added, here::here("Dataset","London_NCR_GSS_Added.csv"), append = F, col_names = T)
write.csv(London_NCR_GSS_Added, here::here("Dataset","London_NCR_GSS_Added.csv"), row.names = FALSE, col.names = TRUE)
# "col.names = TRUE" is important to be writen down
          
```


### Heat Map making 

- there comes a map of London borough in order to draw point in this map after data preparation
```{r}
library(sf)
London_Borough = st_read("/Users/fangzeqiang/Desktop/SDSV/Final/CASA0005_Final_Assessment/Dataset/statistical-gis-boundaries-london/ESRI/London_Borough_Excluding_MHW.shp")
# .shp should be loaded in ESRI folder and path instead of relative path!
# plot(London_Borough)
 plot(st_geometry(London_Borough))
```

- Then read csv in mycsv
```{r}
# library(tidyverse)
mycsv = London_NCR_GSS_Added
```


- In order to make heat mapping, count the frequency of GSS_CODE
```{r}
# mycsv_frequency_by_gsscode
mycsv_fba = mycsv %>%
  group_by(GSS_CODE) %>% # group by GSS_CODE
  summarise(Freq = n())

ncol(mycsv_fba)
nrow(mycsv_fba)
```

- 方法一：全连接
![merge function](https://img-blog.csdn.net/20180304105932852?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvbmV3ZWFzdHN1bg==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)
```{r}
# sample1:  full_join(x,y, by = NULL, copy = FALSE, suffix = c(".x", ".y"), ...)
All_join_London_Borough_Shape = London_Borough %>%
  merge(.,
        mycsv_fba,
        by.x = "GSS_CODE",
        by.y = "GSS_CODE",
        all = TRUE)

# 需要数据处理一下把 Freq变量缺失的改成0

fun1 <- function(x) {
     x[is.na(x)] = 1
     x
}
sapply(All_join_London_Borough_Shape, fun1)

nrow(All_join_London_Borough_Shape)
ncol(All_join_London_Borough_Shape)
All_join_London_Borough_Shape %>%
  names()
```

- 方法二：内连接把London_Borough与mycsv_fba中匹配的数据加入mycsv_fda中Join
```{r}
London_Borough_Shape = London_Borough %>%
  merge(.,
        mycsv_fba,
        by.x = "GSS_CODE",
        by.y = "GSS_CODE")
```

check the new shape
```{r}
London_Borough_Shape%>%
  head(.,n=10)
```

- heat map making preparation
tip: library(tmap) will take a while, maybe 4min
```{r}
library(tmap)
tmap_mode("plot")
```

- fill by frequency 
```{r}
London_Borough_Shape %>%
  qtm(.,fill = "Freq")
```
- fill by frequency_test_1
```{r}
All_join_London_Borough_Shape %>%
  qtm(.,fill = "Freq")
```
![London Borough Names](https://i.pinimg.com/originals/e8/c7/10/e8c71070a42fde7bedaafff87379f251.gif)
After observing the map and borough name


limitation:
Accuracy: divid frequency by county may not be the most effcient way to delivery our idea. Maybe the contiunous heat map based on 4324 project will be a good solution.


### Data preprocessing

### Analysis

- weighted 
- 

### Backup

Let's have a try to manipulate data with R
```{r}
London_NCR = read.csv(here::here("Dataset","london-NCR-edit.csv"),
                      header = TRUE,
                      sep = ",",
                      na = "n/a", #fulfill all the N/A value
                      encoding = "latin1")
```

We can see types of all rows
```{r}
library(tidyr,dplyr,tidyverse)
Datatypelist = London_NCR %>% 
  summarise_all(class) %>%
  pivot_longer(everything(), 
               names_to="All_variables", 
               values_to="Variable_class")

Datatypelist
```

Read london-NCR-edit data in R again!
```{r}
London_NCR = read_csv(here::here("Dataset","london-NCR-edit.csv"),
                       locale = locale(encoding = "latin1"))
```

Overview of london-NCR
```{r}
head(colnames(London_NCR))
```

Take a snapshot of county of data and delete the distinct stuff
```{r}
County_GreaterLondon = London_NCR %>%
  filter(`county` == "Greater London") # similar to filter function in excel
#summary(County_GreaterLondon)
County_GreaterLondon = County_GreaterLondon %>%
  distinct()
#summary(County_GreaterLondon)
```

But there is not all of cols we need. In the next step, we need to select valuable cols to analysis
```{r}
# we can get the index
```

read .gpkg in systems
```{r}
library(sf)
charging_points = st_read("/Users/fangzeqiang/Downloads/Rapid_charging_points.gpkg")
```

```{r}
# charging_points %>%
#   names()
charging_points %>%
  nrow()
```

